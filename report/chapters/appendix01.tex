\chapter{On Constraint Satistfaction Problems}
\label{appendix:CSP}
In the previous chapters, we described how the system works, without formalising the CSP approach.\newline
On this chapter, we will describe the CSP systems that we have used, with an equivalence proof between them.

\section{Constraint Satisfaction Problem}
\subsection{Definition}
A constraint satisfaction problem
\subsection{Assignment}
An assignment of a $\CSP(\mathcal{X},D,\Gamma)$ is a function $X:\mathcal{X}\rightarrow D$ such that, by replacing each $x\in\mathcal{X},$ by $X(x),$ all the constraints will evaluate to $\True$
\subsection{Polymorphism}
A function $F:\mathscr{F}(\mathcal{X},D)^k\rightarrow \mathscr{F}(\mathcal{X},D)$ is said to be a polymorphism if:
$$
\forall X_1,\dots,X_k \ \text{assignments of}\ \CSP(\mathcal{X},D,\Gamma),\quad F(X_1,\dots,X_k) \ \text{is also an assignment of}\ \CSP(\mathcal{X},D,\Gamma)
$$
Now, in the next section, we will define an important class of CSPs that is used to solve Mean Payoff Games, with the polymorphisms required for the solution algorithm's correctness

\section{Ternary Max Atom Systems}
\subsection{Definition}
\begin{itemize}
	\item Let $\mathcal{X}$ be a finite set of variables
	\item Let $D=I\cup \{-\infty\},$ with $I\subseteq \mathbb{R}$.
	\item  For $x,y,z\in \mathcal{X},c\in I$, let $\text{MA}_3(x,y,z,c)$ be defined as follow:
	$$
	\text{MA}_3(x,y,z,c)\iff x\le \max(y,z)+c
	$$
\end{itemize}
A ternary max atom system is $\CSP(D,\Gamma)$ where:
\begin{align*}
	\Gamma&=\left\{\text{MA}_3(x,y,z,c),\quad (x,y,z,c)\in \mathscr{R}\right\}\\
	\mathscr{R}&\subseteq \mathcal{X}^3\times I\\
	\mathscr{R}& \space \text{is finite}
\end{align*}
\subsection{Example}
An example of a ternary max atom system is the following $\CSP(D,\Gamma)$ with $D=\mathbb{Z}$ and $\Gamma$ represented as follow:
\begin{align*}
	x &\le \max(y,z)-1 \\
	y &\le \max(z,x)-1 \\
	z & \le \max(x,y)-1
\end{align*}


\section{Max Atom Systems}
\subsection{Definition}
\begin{itemize}
	\item Let $\mathcal{X}$ be a finite set of variables
	\item Let $D=I\cup \{-\infty\},$ with $I\subseteq \mathbb{R}$   
	\item For $x\in \mathcal{X},Y\subseteq\mathcal{X}^m,c\in I$, let $\text{MA}(x,Y,c)$ be defined as follow:
	$$
	\text{MA}(x,Y,c)\iff x\le \max Y+c
	$$
\end{itemize}

A max atom system is $\CSP(D,\Gamma)$ where:

\begin{align*}
	\Gamma&=\left\{\text{MA}(x,Y,c),\quad (x,Y,c)\in \mathscr{R}\right\}\\
	\mathscr{R}&\subseteq \mathcal{X}\times \left(\mathscr{P}(\mathcal{X}) \setminus \{\varnothing\}\right)\times I \\
	\mathscr{R}&\space \text{is finite}
\end{align*}

\subsection{$\text{MA} \le \text{MA}_3$}
\begin{itemize}
	\item Let $S=\CSP(\mathcal{X},D,\Gamma)$ a max atom system.
	\item Let $R\in \Gamma$
	\item Let $x\in \mathcal{X},Y\in\mathscr{P}(\mathcal{X}),c\in I$ such that $R=\text{MA}(x,Y,c)$ such that $\lvert Y \rvert >2$
\end{itemize}

\subsubsection{Recursive Reduction}
We will reduce the arity of $R$ as follow:
\begin{itemize}
	\item Let $y,z\in Y$ such that $y\ne z$
	\item We introduce a variable $w\notin \mathcal{X}$
	\item Let $\mathcal{X}'=\mathcal{X}\cup\{w\}$
	\item Let $Y'=(Y\cup \{w\})\setminus\{y,z\}$
	\item Let $R'=\text{MA}(x,Y',c)$
	\item Let $R_w=\text{MA}(w,\{y,z\},0)$
	\item Let $\Gamma'=(\Gamma\cup\{R',R_w\})\setminus \{R\}$
	\item Let $S'=\CSP(\mathcal{X}',D,\Gamma)$
\end{itemize}


We will prove that $S'$ is equivalent to $S.$

\paragraph{Implication}
Let $X:\mathcal{X}'\rightarrow D$ an assignment of $S'.$ It is trivial that by removing $X(w)$, $X_{\mid \mathcal{X}}$ is an assignment of $S$ 

\paragraph{Equivalence}
\begin{itemize}
	\item Let $X:\mathcal{X}'\rightarrow D$ such that $X_{\mid \mathcal{X}}$ is an assignment of $S.$
	\item We will set $X(w)=\max(X(y),X(z))$
\end{itemize}
Then, $X$ is an assignment of $S'$

\subsubsection{Induction}
Since the number of variables is finite, the arity of each constraint is finite. Also, as the the number of constraints is finite, Applying such reduction iteratively will eventually give a system $S^*$ equivalent to $S$ with:
\begin{itemize}
	\item $\mathcal{X}^*$ the set of variables with $\mathcal{X}\subseteq \mathcal{X}^*$ 
	\item $\Gamma^*$ is the set of constraints:
	\item Each constraint is of the form $\text{MA}(x,Y,c)$ with $x\in \mathcal{X}^*,Y\subseteq \mathcal{X}^*,c\in I$ with $\lvert Y\rvert \le 2$   
\end{itemize}
Now such system can be transformed to a ternary system $S_3$ as follow:
\begin{itemize}
	\item The set of variables is $\mathcal{X}^*$
	\item The domain is $D$
	\item For every relation $R=\text{MA}(x,Y,c)$ we map it to the relation $R_3=\text{MA}(x,y,z,c)$ as follow:
	\begin{itemize}
		\item If $\lvert Y \rvert=2$, then $y,z$ are the elements of $Y.$
		\item Otherwise, $\lvert Y \rvert=1,$ and $y=z$ are the same element of the singleton\footnote{A set with only one element} $Y.$
	\end{itemize}
	
\end{itemize}


It is trivial that $S^*$ is equivalent to $S_3.$
With that, $S$ is equivalent to $S_3.$


\begin{algorithm}
	\caption{Converting a Max Atom System to Ternary Max Atom System}\label{alg:MaxAtomToTernaryMaxAtom}
	\begin{algorithmic}
		\Require $S$ an $N$-ary Max Atom system
		\Ensure $S'$ a ternary Max Atom system  
		\State $S'\leftarrow \varnothing$
		\State $H\leftarrow\varnothing$ \Comment{$H$ is a symmetric map between variable,variable to variables}
		\State $V\leftarrow \text{Variables}(S)$  \Comment{$V$ is a set containing all variables}
		\For {$\mathcal{C}\in S$}
		\Comment{Iterate over constraints}
		\State $c$ is the constant in the right hand side of $\mathcal{C}$
		\State $Y$ is the variables in the right hand side of $\mathcal{C}$
		\State $x$ is the variable in the left hand side of $\mathcal{C}$
			\While{$\lvert Y \rvert > 2$}
				\State $y\leftarrow \pop(Y)$
				\State $z\leftarrow \pop(Y)$
				\If {$(y,z) \notin \domain  H$}
					\State $w\leftarrow \text{newVariable}(V)$\Comment{Generate a new formal variable not included in $V$}
					\State $V\leftarrow V\cup\{w\}$
					\State $H(y,z)\leftarrow w$
					\State $H(z,y)\leftarrow w$
				\EndIf
				\State $w\leftarrow H(y,z)$
				\State $S'\leftarrow S'\cup\{\text{MA}(w,y,z,c)\}$
				\State $Y\leftarrow Y\cup\{w\}$
			\EndWhile
		\EndFor
		\State \Return $S'$
	\end{algorithmic}
\end{algorithm}
\subsection{Polymorphisms}
Two main family of polymorphisms are defined for Max Atom systems:
\begin{itemize}
	\item The max polymorphisms $M^{k}$ defined by:
	$$
	M^{k}(X_1,\dots,X_k)(x) = \max_{k\in\{1,\dots,k\}} X_k(x)
	$$
	\item The translation polymorphisms $T_{c}$ defined by:
	$$
	T_c(X)(x)=X(x)+c
	$$
\end{itemize}

\section{Min-Max System}

\begin{itemize}
	\item Let $\mathcal{X}$ be a finite set of variables
	\item Let $I$ be the domain of the variables.
	\item Let $D=I\cup \{-\infty\},$ with $I\subseteq \mathbb{R}$  
	\item For $x\in \mathcal{X},Y\subseteq\mathcal{X}^m,C\in I^m$, let $\text{MA}(x,Y,C)$ be defined as follow:
	$$
	\text{MA}(x,Y,c)\iff x\le \max (Y+C)
	$$
	\item For $x\in \mathcal{X},Y\subseteq\mathcal{X}^m,C\in I^m$, let $\text{MI}(x,Y,C)$ be defined as follow:
	$$
	\text{MI}(x,Y,C)\iff x\le \min (Y+C)
	$$
\end{itemize}

A min-max system is $\CSP(D,\Gamma)$ where:
\begin{align*}
	\Gamma&=\left\{O(x,Y,C),\quad (O,x,Y,C)\in \mathscr{R}\right\}\\
	\mathscr{R}&\subseteq \{\text{MA},\text{MI}\}\times\mathcal{X}\times \left(\mathcal{X}\times I\right)^+ \\
	\mathscr{R}&\  \text{is finite}
\end{align*}


\subsection{Transforming to Max Atom Systems}
A Max Atom system is trivially a Min Max system. So we will only prove the latter implication.

Let $S'=\CSP(D,\Gamma)$ be a Min Max system, and let:
\begin{itemize}
	\item $\Gamma_{\text{MI}}$ be the constraints that has $\text{MI}$ 
	\item $\Gamma_{\text{MA}}$ be the constraints that has $\text{MA}$
\end{itemize}
\subsubsection{Transforming $\text{MI}$ constraints}
For each $\text{MI}(x,Y,c)\in \Gamma_{\text{MI}}.$ we replace it with the following constraints:
$$
\Gamma^{x,Y,C}_{\text{MI}}=\left\{\text{MA}(x,\{y\},c),\quad y,c\in \zip(Y,C)\right\}
$$
\subsubsection{Tranforming $\text{MA}$ constraints}
For each $(y,c)\in \mathcal{X}\times I$ present in a max constraint of the system: \begin{itemize}
	\item We add a formal variable $z^{y,c}$ if $c\ne 0.$
	\item Else, we will simply represent by $z^{y,c}$ the variable $y.$
\end{itemize}
By denoting $Z^{Y,C}$ the following set:
$$
Z^{Y,C}=\{z^{y,c},\quad (y,c)\in \zip(Y,C)\}
$$
We build the following constraints:
$$
\Gamma^{x,Y,C}_{\text{MA}} = \left\{\text{MA}(x,Z^{Y,C},0)\right\}\cup\{\text{MA}(z^{y,c},\{y\},c),\quad (y,c)\in \zip(Y,C)\}
$$
\subsubsection{Building the Max Atom System}
Now, let:
$$
\Gamma'=\bigcup_{\text{OP}\in\{\text{MI},\text{MA}\}}\bigcup_{\text{OP}(x,Y,C)\in \Gamma_{\text{OP}}} \Gamma^{x,Y,C}_{\text{OP}}
$$
The system $\CSP(D,\Gamma')$ is an equivalent max system.
\subsubsection{Equivalence}
Let:
\begin{itemize}
	\item $\mathcal{X}' = \mathcal{X}\cup \mathcal{X}_{\text{Generated}}$ the augmented set of variables.
	\item $\mathcal{C}=\text{OP}(x,Y,C)\in \CSP(D,\Gamma)$ be a constraint.
	\item $X:\mathcal{X'}\rightarrow D$ an assignment of $\CSP(D,\Gamma').$
\end{itemize}
If $\text{OP}=\text{MI},$ it is trivial that $\text{OP}(x,Y,C)$ is equivalent to $\Gamma^{x,Y,C}_{\text{OP}}.$
\newline Otherwise, for each $(y,c)\in \zip(Y,C)$ we have:
$$
X(z^{y,c}) \le \max\{X(y)\}+c = X(y)+c
$$
Now, we also have:
$$
X(x) \le \max_{(y,c)\in\zip(Y,C)}X(z^{y,c}) +0 \le \max_{(y,c)\in \zip(Y,C)}\left(X(y)+c\right)
$$
With that, $X_{\mid \mathcal{X}}$ is an assignment of $\CSP(D,\Gamma)$
\begin{algorithm}
	\caption{Converting a Min-Max System to Max Atom}\label{alg:MinMaxToMaxAtom}
	\begin{algorithmic}
		\Require $S$ a Min-Max system
		\Ensure $S'$ an $N$-ary Max Atom system  
		\State $S'\leftarrow \varnothing$
		\State $H\leftarrow\varnothing$ \Comment{$H$ is a map between variable,offsets to variables}
		\State $V\leftarrow \text{Variables}(S)$  \Comment{$V$ is a set containing all variables}
		\For {$\mathcal{C}\in S$}
		 \Comment{Iterate over constraints}
		 \State $C$ is the constants in the right hand side of $\mathcal{C}$
		 \State $Y$ is the variables in the right hand side of $\mathcal{C}$
		 \State $x$ is the variable in the left hand side of $\mathcal{C}$
		\If {$\mathcal{C}$ is a min constraint}
			\State $S'\leftarrow S'\cup\left\{\text{MA}(x,\{y,y\},c),\quad (y,c)\in \zip(Y,C)\right\}$
		\Else
			\State $Z\leftarrow \varnothing$
			\For {$(y,c)\in \zip(Y,C)$}
				\If {$(y,c) \notin \domain{H}$}
					\State $z\leftarrow \text{newVariable}(V)$ \Comment{Generate a new formal variable not included in $V$}
					\State $V\leftarrow V\cup\{z\}$
					\State $H(y,c)\leftarrow z$
				\EndIf
				\State $S'\leftarrow S'\cup\{\text{MA}(H(y,c),\{y,y\},c)\}$
				\State $Z\leftarrow Z\cup \{H(y,c)\} $
			\EndFor
			\State $S' \leftarrow S' \cup \{\text{MA}(x,Z,0)\}$
		\EndIf
		\EndFor
	\end{algorithmic}
\end{algorithm}
\section{Solving Mean Payoff}
\subsection{Reduction to Min Max System}
In this section, we will solve the mean payoff by converting it to a equivalent min max system.
\newline The method we use is formalised in \cite{MPGMaxAtom}, and the equivalence is also proven in \cite{MPGMaxAtom}.
\begin{algorithm}
	\caption{Converting a Mean Payoff Game to a Min Max system}\label{alg:MPGToMinMax}
	\begin{algorithmic}
		\Require $G$ a Mean Payoff Game
		\Ensure $S$ an Min-Max system 
		\State $E\leftarrow E(G)$ \Comment{The edges of $G$}
		\State $V\leftarrow V(G)$\Comment{The variables of $G$}
		\State $W \leftarrow W(G)$ \Comment{The weight function of $G$}
		\State $P \leftarrow P(G)$ \Comment{The set of player of $G$}
		\For {$(u,p) \in V\times P$}
			\State $x\leftarrow (u,p)$
			\State $A\leftarrow \Adj(x)$
			\State $Y=\{(a,\bar{p}),\quad a\in A\}$
			\State $C\leftarrow W(A)$ \Comment{Calculating the weights element wise.}
			\If {$p$ is Max}:
				\State $\text{OP}\leftarrow \text{MA}$			
			\Else
				\State $\text{OP}\leftarrow \text{MI}$	
			\EndIf
			\State $S\leftarrow S\cup \left\{\text{OP}(x,Y,C)\right\}$
		\EndFor
	\end{algorithmic}
\end{algorithm}
\subsection{Arc Consistency}
\subsubsection{First Implementation}
At first, we took the original implementation of AC3 \cite[page.~171]{AIModernApproach} and modify it to support the max atom system:
\begin{algorithm}
	\caption{AC3 for Ternary Max Atom systems}\label{alg:AC3}
	\begin{algorithmic}
		\Require $\mathcal{C}$ a ternary Max Atom constraint
		\Require $\nu:V\rightarrow \mathscr{P}(D)$ the admissible values function
		\Require $Q$ a Queue of pending updates
		\Ensure $\nu$ update the admissible values function.
		\State	$x\leftarrow$ the left-hand side of $\mathcal{C}$
		\State	$(y,z)\leftarrow$ the right-hand side variables of $\mathcal{C}$
		\State	$c\leftarrow$ the right-hand side constant $\mathcal{C}$
		\State $Z\leftarrow [x,y,z]$
		\For {$o\in \{0,1,2\}$} \Comment{Iterate over all rotations}
			\State $\text{admissible}\leftarrow \False$
			\State $x\leftarrow Z[o]$
			\State $y\leftarrow Z[(o+1)\bmod 3]$
			\State $z\leftarrow Z[(o+2)\bmod 3]$
			\State $\mu\leftarrow \varnothing$ \Comment{Set of values to delete}
			\For {$a\in \nu(x)$}
				\For {$(b,c)\in \nu(y)\times \nu(z)$}
					\State $T\leftarrow[a,b,c]$
					\State $p\leftarrow T[(-o)\bmod 3]$
					\State $q\leftarrow T[(1-o)\bmod 3]$
					\State $q\leftarrow T[(2-o)\bmod 3]$
					\If {$p\le \max(q,r)+c$}
						\State $\text{admissible}\leftarrow \True$
					\EndIf
				\EndFor
				\If	{$\Not \text{admissible}$}
					\State $\mu\leftarrow \mu \cup \{a\}$
				\EndIf
			\EndFor
			\If {$\lvert \mu \rvert >0$}
				\State $\nu(x)\leftarrow \nu(x)\setminus \mu$
				\State $\text{append}(Q,\Adj x)$
			\EndIf

		\EndFor
	\end{algorithmic}
\end{algorithm}
\FloatBarrier
This version was very slow, took a considerable time even for Mean Payoff Games with less than $20$ vertices.
\subsubsection{Refinement}
We were able to make many simplifications to the algorithm by taking advantage of the symmetry\footnote{$\max$ is a symmetric function: $\max(x,y)=\max(y,x)$} of the system and the fact that it has translations and maximum as polymorphisms \cite{TropicalCSP}:
\begin{algorithm}
	\caption{AC3 Optimized for Ternary Max Atom systems}\label{alg:AC3Optimized}
	\begin{algorithmic}
		\Require $\mathcal{C}$ a ternary Max Atom constraint
		\Require $\nu:V\rightarrow D$ the maximum admissible value for each variable.
		\Require $Q$ a Queue of pending updates
		\Require $L=\inf D$ the smallest admissible value
		\Ensure $\nu$ update the maximum admissible values function.
		\State	$x\leftarrow$ the left-hand side of $\mathcal{C}$
		\State	$(y,z)\leftarrow$ the right-hand side variables of $\mathcal{C}$
		\State	$c\leftarrow$ the right-hand
		\State $r\leftarrow \max(\nu(y),\nu(z))+c$
		\If {$r < L$}
			\State $r\leftarrow -\infty$
		\EndIf
		\If {$r < \nu(x) $}
			\State $\nu(x)\leftarrow r$
			\State $\text{append}(Q,x)$
		\EndIf
	\end{algorithmic}
\end{algorithm}

